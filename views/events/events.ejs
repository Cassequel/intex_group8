<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Events | Ella Rises</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/styles/styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
</head>
<body>
  <!-- NAVBAR -->
  <%- include('../partials/navbar') %>

  <!-- HERO -->
  <section class="hero">
    <div class="hero-overlay"></div>
    <div class="container hero-content">
      <p class="eyebrow">Programs</p>
      <h1>Events</h1>
      <p class="hero-subtitle">Browse and manage scheduled events.</p>
      <% if (userLevel === 'M') { %>
        <div class="hero-actions">
          <a href="/events/new" class="btn btn--primary">Add event</a>
        </div>
      <% } %>
    </div>
  </section>

  <!-- EVENTS TABLE -->
  <section class="section section--light">
    <div class="container">
      <div class="section-header">
        <h2>All events</h2>
        <p>A snapshot of current events.</p>
      </div>

      <div class="table-card">
        <div class="table-card__header">
          <span>Events</span>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
            <input type="search" id="eventSearch" placeholder="Search events..." style="padding: 0.5rem 0.75rem; border: 1px solid var(--color-border); border-radius: 10px; min-width: 200px;" />
            <select id="typeFilter" style="padding: 0.5rem 0.75rem; border: 1px solid var(--color-border); border-radius: 10px;">
              <option value="all">All types</option>
              <option value="leadership">Leadership</option>
              <option value="stem">STEM</option>
              <option value="arts">Arts</option>
              <option value="annual-conference">Annual Conference</option>
            </select>
            <label style="display: inline-flex; align-items: center; gap: 0.35rem; font-size: 0.9rem;">
              Capacity ≤ <span id="capacityValue">500</span>
              <input type="range" id="capacityFilter" min="0" max="500" value="500" />
            </label>
            <select id="locationFilter" style="padding: 0.5rem 0.75rem; border: 1px solid var(--color-border); border-radius: 10px;">
              <option value="all">All locations</option>
              <option value="online">Online</option>
              <option value="inperson">In person</option>
            </select>
            <% if (userLevel === 'M') { %>
              <a href="/events/new" class="btn btn--primary btn--small">Add event</a>
            <% } %>
          </div>
        </div>
        <div class="table-card__body">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Type</th>
                <th>Starts</th>
                <th>Location</th>
                <th>Capacity</th>
                <% if (userLevel === 'M') { %><th>Actions</th><% } %>
              </tr>
            </thead>
            <tbody>
              <% if (events && events.length) { %>
                <% events.forEach((event) => { %>
                  <tr
                    data-name="<%= (event.event_name || '').toLowerCase() %>"
                    data-type="<%= (event.event_type || '').toLowerCase() %>"
                    data-capacity="<%= typeof event.event_capacity !== 'undefined' && event.event_capacity !== null ? event.event_capacity : 0 %>"
                    data-location="<%= (event.event_location || '').toLowerCase() %>"
                  >
                    <td><%= event.event_occurence_id %></td>
                    <td><a href="/events/<%= event.event_occurence_id %>"><%= event.event_name %></a></td>
                    <td><%= event.event_type || "—" %></td>
                    <td>
                      <%
                        const start = event.event_date_time_start;
                        let startDate = "";
                        if (start) {
                          startDate = start.toISOString ? start.toISOString().replace('T', ' ').slice(0,16) : String(start);
                        }
                      %>
                      <%= startDate %>
                    </td>
                    <td><%= event.event_location || "—" %></td>
                    <td><%= typeof event.event_capacity !== "undefined" && event.event_capacity !== null ? event.event_capacity : "—" %></td>
                    <% if (userLevel === 'M') { %>
                      <td class="table-actions">
                        <a class="btn btn--outline btn--small" href="/events/<%= event.event_occurence_id %>/edit">Edit</a>
                        <form class="inline-form" method="POST" action="/events/<%= event.event_occurence_id %>/delete">
                          <button type="submit" class="btn btn--ghost btn--small">Delete</button>
                        </form>
                      </td>
                    <% } %>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="<%= userLevel === 'M' ? 8 : 7 %>" class="empty-row">No events found.</td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <script>
    const navToggle = document.querySelector(".nav-toggle");
    const navLinks = document.querySelector(".nav-links");
    navToggle.addEventListener("click", () => {
      navLinks.classList.toggle("nav-links--open");
      navToggle.classList.toggle("nav-toggle--open");
    });

    // Filters
    const eventSearch = document.getElementById("eventSearch");
    const typeFilter = document.getElementById("typeFilter");
    const capacityFilter = document.getElementById("capacityFilter");
    const capacityValue = document.getElementById("capacityValue");
    const locationFilter = document.getElementById("locationFilter");
    const eventRows = Array.from(document.querySelectorAll("tbody tr"));

    const applyFilters = () => {
      const term = eventSearch.value.trim().toLowerCase();
      const typeVal = typeFilter.value;
      const capacityVal = parseInt(capacityFilter.value || "0", 10);
      const locVal = locationFilter.value;
      capacityValue.textContent = capacityVal;

      eventRows.forEach((row) => {
        const name = row.dataset.name || "";
        const template = row.dataset.template || "";
        const type = row.dataset.type || "";
        const capacity = parseInt(row.dataset.capacity || "0", 10);
        const location = row.dataset.location || "";
        const rowText = row.textContent.toLowerCase();

        const matchesSearch = !term || name.includes(term) || type.includes(term) || template.includes(term) || rowText.includes(term);
      const matchesType =
        typeVal === "all" ||
        (typeVal === "leadership" && type.includes("leadership")) ||
        (typeVal === "stem" && type.includes("stem")) ||
        (typeVal === "arts" && type.includes("art")) ||
        (typeVal === "annual-conference" && type.includes("annual") && type.includes("conference"));
        const matchesCapacity = capacity <= capacityVal;
        const isOnline = location.includes("virtual zoom") || location.includes("online");
        const matchesLocation =
          locVal === "all" ||
          (locVal === "online" && isOnline) ||
          (locVal === "inperson" && !isOnline);

        row.style.display = matchesSearch && matchesType && matchesCapacity && matchesLocation ? "" : "none";
      });
    };

    eventSearch?.addEventListener("input", applyFilters);
    typeFilter?.addEventListener("change", applyFilters);
    capacityFilter?.addEventListener("input", applyFilters);
    locationFilter?.addEventListener("change", applyFilters);

    applyFilters();
  </script>
</body>
</html>
